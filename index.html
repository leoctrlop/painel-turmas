<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Turmas</title>
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; padding: 20px; background: #f4f4f8; color: #222; }
    h1 { text-align: center; margin-bottom: 20px; }

    .layout { display: grid; grid-template-columns: 1.2fr 1.8fr; gap: 20px; align-items: flex-start; }

    .lista-header { display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
    .lista-header-title { font-weight: 600; font-size: 0.95rem; }
    .filtros-row { display: flex; flex-wrap: wrap; gap: 6px; }
    .filtro-select {
      padding: 4px 8px; border-radius: 999px; border: 1px solid #d1d5db;
      font-size: 0.8rem; background: #f9fafb;
    }

    .turma-lista {
      background: #fff; border-radius: 12px; padding: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08); max-height: 80vh; overflow-y: auto;
    }
    .turma-card {
      border-radius: 10px; padding: 10px 12px; margin-bottom: 8px; cursor: pointer;
      border: 1px solid #ddd; display: flex; flex-direction: column; gap: 4px;
      transition: 0.15s ease;
    }
    .turma-card:hover { background: #f0f7ff; transform: translateY(-1px); }
    .turma-card.selecionada { border-color: #2563eb; background: #e0edff; }
    .turma-nome { font-weight: 600; font-size: 0.95rem; }
    .turma-meta { font-size: 0.8rem; color: #555; }

    .badge {
      display: inline-block; font-size: 0.75rem; padding: 2px 8px;
      border-radius: 999px; color: #fff; margin-right: 4px;
    }
    .badge-status-andamento { background: #16a34a; }
    .badge-status-formacao { background: #eab308; }
    .badge-status-encerrada { background: #dc2626; }

    .badge-kids { background: #3b82f6; }
    .badge-teens { background: #f97316; }
    .badge-young { background: #a855f7; }

    .painel {
      background: #fff; border-radius: 12px; padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      min-height: 200px; display: flex; flex-direction: column; gap: 10px;
    }

    /* abas do painel */
    .painel-tabs { display: flex; gap: 6px; margin-bottom: 4px; }
    .tab-btn {
      border: none; border-radius: 999px;
      background: #e5e7eb; color: #111827;
      padding: 4px 10px; font-size: 0.8rem;
      cursor: pointer; transition: 0.15s;
    }
    .tab-btn.tab-ativa { background: #2563eb; color: #fff; }
    .tab-btn:hover { filter: brightness(0.95); }

    .painel-titulo { font-size: 1.05rem; font-weight: 600; }

    .painel-botoes { display: flex; gap: 10px; margin-top: 4px; }

    .btn {
      border: none; border-radius: 999px; padding: 8px 16px; font-size: 0.9rem;
      cursor: pointer; display: inline-flex; align-items: center;
      justify-content: center; gap: 6px; transition: 0.15s ease;
    }
    .btn-primario { background: #2563eb; color: #fff; }
    .btn-secundario { background: #e5e7eb; color: #111827; }
    .btn:hover { filter: brightness(0.95); transform: translateY(-0.5px); }

    .conteudo { margin-top: 6px; border-top: 1px solid #e5e7eb; padding-top: 10px; font-size: 0.9rem; }
    .conteudo h3 { margin-top: 0; margin-bottom: 8px; }

    .linha-info {
      display: flex; justify-content: space-between;
      padding: 4px 0; border-bottom: 1px dashed #eee;
    }
    .campo-label { color: #4b5563; }
    .campo-valor { font-weight: 500; color: #111827; margin-left: 8px; }

    .processos-grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
    .processo-card {
      border-radius: 10px; border: 1px solid #e5e7eb;
      padding: 8px 10px; cursor: pointer; transition: 0.15s ease;
    }
    .processo-card:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.06); }
    .processo-titulo { font-weight: 500; margin-bottom: 3px; }
    .processo-sub { font-size: 0.8rem; color: #4b5563; margin-bottom: 4px; }
    .processo-status-label { font-size: 0.8rem; font-weight: 500; }

    .status-neutro { background: #ffffff; color: #111827; }
    .status-embreve { background: #fef3c7; color: #7c2d12; }
    .status-atrasado { background: #fee2e2; color: #7f1d1d; }
    .status-feito { background: #dcfce7; color: #065f46; }

    /* vis√£o geral em tabela */
    .tabela-visao-geral {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.8rem;
    }
    .tabela-visao-geral th,
    .tabela-visao-geral td {
      border: 1px solid #e5e7eb;
      padding: 4px 6px;
    }
    .tabela-visao-geral th {
      background: #f3f4f6;
      position: sticky;
      top: 0;
      z-index: 1;
      font-weight: 600;
    }
    .col-turma {
      text-align: left;
      white-space: nowrap;
      font-weight: 500;
      background: #f9fafb;
    }
    .cel-processo {
      text-align: center;
      min-width: 90px;
    }

    @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <h1>Painel de Turmas</h1>

  <div class="layout">
    <!-- Lista de Turmas -->
    <div class="turma-lista" id="listaTurmas">
      <div class="lista-header">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
          <div class="lista-header-title">Turmas</div>
          <button
            class="btn btn-primario"
            style="padding:4px 10px; font-size:0.8rem;"
            onclick="abrirFormularioNovaTurma()">
            + Nova turma
          </button>
  </div>
        <div class="filtros-row">
          <select id="filtroNivel" class="filtro-select" onchange="alterarFiltros()">
            <option value="todos">N√≠vel: todos</option>
            <option value="Kids">Kids</option>
            <option value="Teens">Teens</option>
            <option value="Young">Young</option>
          </select>
          <select id="filtroDia" class="filtro-select" onchange="alterarFiltros()">
            <option value="todos">Dia: todos</option>
            <option value="Segunda">Segunda</option>
            <option value="Ter√ßa">Ter√ßa</option>
            <option value="Quarta">Quarta</option>
            <option value="Quinta">Quinta</option>
            <option value="Sexta">Sexta</option>
            <option value="S√°bado">S√°bado</option>
          </select>
          <select id="filtroHorario" class="filtro-select" onchange="alterarFiltros()">
            <option value="todos">Hor√°rio: todos</option>
          </select>
          <select id="filtroStatus" class="filtro-select" onchange="alterarFiltros()">
            <option value="todas">Status: todos</option>
            <option value="Em andamento">Em andamento</option>
            <option value="Em forma√ß√£o">Em forma√ß√£o</option>
            <option value="Encerrada">Encerrada</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Painel -->
    <div class="painel">
      <div class="painel-tabs">
        <button id="tabTurma" class="tab-btn tab-ativa" onclick="setModoPainel('turma')">
          Painel por turma
        </button>
        <button id="tabOverview" class="tab-btn" onclick="setModoPainel('overview')">
          Vis√£o geral dos processos
        </button>
      </div>

      <div class="painel-titulo" id="tituloTurma">
        Selecione uma turma √† esquerda 
      </div>

      <div class="painel-botoes" id="botoesAcoes" style="display:none;">
        <button class="btn btn-primario" onclick="mostrarSecao('acompanhar')">
          üìä Acompanhar turma
        </button>
        <button class="btn btn-secundario" onclick="mostrarSecao('processos')">
          ‚öôÔ∏è Processos da turma
        </button>
      </div>

      <div class="conteudo" id="conteudoTurma"></div>
    </div>
  </div>

  <!-- SCRIPT COM FIREBASE + L√ìGICA -->
 <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  // === FUN√á√ïES GLOBAIS DE EXCLUIR E FORM NOVA TURMA ===
  let turmas = [];
  let turmaSelecionada = null;
  let modoPainel = "turma";
  let filtroNivel = "todos";
  let filtroDia = "todos";
  let filtroHorario = "todos";
  let filtroStatus = "todas";
  const cicloStatusProcesso = ["neutro", "embreve", "atrasado", "feito"];
  const statusLabelMap = {
    neutro: "Neutro",
    embreve: "Em breve",
    atrasado: "Atrasado",
    feito: "Feito"
  };
  let statusProcessosFirebase = {};

  window.excluirTurmaSelecionada = function (idTurma, ev) {
    if (ev) ev.stopPropagation();
    const id = idTurma || (turmaSelecionada && turmaSelecionada.id);
    if (!id) {
      alert("Nenhuma turma selecionada.");
      return;
    }

    const turma = turmas.find(t => t.id === id);
    const nomeTurma = turma ? turma.nome : id;

    const confirma = confirm(
      `Deseja realmente EXCLUIR a turma "${nomeTurma}" (ID: ${id})?\n\n` +
      "Essa a√ß√£o n√£o pode ser desfeita."
    );
    if (!confirma) return;

    const turmaRef = ref(db, "turmas/" + id);
    remove(turmaRef)
      .then(() => {
        const procRef = ref(db, "processos/" + id);
        remove(procRef).catch(() => {});
        alert("Turma exclu√≠da com sucesso!");
        if (turmaSelecionada && turmaSelecionada.id === id) {
          turmaSelecionada = null;
        }
        renderListaTurmas();
        setModoPainel("overview");
      })
      .catch((err) => {
        console.error("Erro ao excluir turma:", err);
        alert("Erro ao excluir a turma. Veja o console.");
      });
  };

  window.abrirFormularioNovaTurma = function () {
    const modal = document.getElementById("novaTurmaContainer");
    if (!modal) return;

    document.getElementById("novaTurmaId").value = "";
    document.getElementById("novaTurmaNome").value = "";
    document.getElementById("novaTurmaNivel").value = "Teens";
    document.getElementById("novaTurmaDia").value = "S√°bado";
    document.getElementById("novaTurmaHorario").value = "";
    document.getElementById("novaTurmaStatus").value = "Em forma√ß√£o";
    document.getElementById("novaTurmaAlunos").value = "";
    document.getElementById("novaTurmaDataInicio").value = "";
    document.getElementById("novaTurmaDataFim").value = "";

    modal.style.display = "flex";
  };

  window.fecharFormularioNovaTurma = function () {
    const modal = document.getElementById("novaTurmaContainer");
    if (!modal) return;
    modal.style.display = "none";
  };

  window.salvarNovaTurma = function () {
    const modal = document.getElementById("novaTurmaContainer");
    if (!modal) return;

    const id         = document.getElementById("novaTurmaId").value.trim();
    const nome       = document.getElementById("novaTurmaNome").value.trim();
    const nivel      = document.getElementById("novaTurmaNivel").value;
    const dia        = document.getElementById("novaTurmaDia").value;
    const horario    = document.getElementById("novaTurmaHorario").value.trim();
    const status     = document.getElementById("novaTurmaStatus").value;
    const alunosStr  = document.getElementById("novaTurmaAlunos").value;
    const dataInicio = document.getElementById("novaTurmaDataInicio").value.trim();
    const dataFim    = document.getElementById("novaTurmaDataFim").value.trim();

    if (!id || !nome || !horario) {
      alert("Preencha pelo menos: ID, nome e hor√°rio da turma.");
      return;
    }

    const jaExiste = turmas.some(t => t.id === id);
    if (jaExiste) {
      alert("J√° existe uma turma com esse ID. Escolha outro ID.");
      return;
    }

    const alunos = alunosStr ? parseInt(alunosStr, 10) : null;

    const dadosNovaTurma = {
      nome,
      nivel,
      dia,
      horario,
      status,
      alunos: isNaN(alunos) ? null : alunos,
      dataInicio: dataInicio || "",
      dataPausa: "",
      periodoFerias: "",
      dataRetorno: "",
      dataFim: dataFim || "",
      totalAulas: null,
      proximoModulo: "",
      grupoWhats: "",
      alinhamentoPais: "",
      audioFeedback: "",
      videosAlunos: "",
      rematricula1: "",
      mensagemTCC: "",
      bombomCartao: "",
      dataTCC: ""
    };

    const turmaRef = ref(db, "turmas/" + id);

    set(turmaRef, dadosNovaTurma)
      .then(() => {
        alert("Turma criada com sucesso!");
        modal.style.display = "none";
        turmaSelecionada = { id, ...dadosNovaTurma };
        renderListaTurmas();
        setModoPainel("turma");
        selecionarTurma(id);
      })
      .catch((err) => {
        console.error("Erro ao criar turma:", err);
        alert("Erro ao criar turma. Veja o console para detalhes.");
      });
  };

  // ===== CONFIG FIREBASE =====
  const firebaseConfig = {
    apiKey: "SUA_API_KEY",
    authDomain: "SEU_DOMINIO.firebaseapp.com",
    databaseURL: "https://painel-turmas-7a2e5-default-rtdb.firebaseio.com",
    projectId: "SEU_PROJECT_ID",
    storageBucket: "SEU_BUCKET.appspot.com",
    messagingSenderId: "SEU_SENDER_ID",
    appId: "SEU_APP_ID"
  };

  const app  = initializeApp(firebaseConfig);
  const db   = getDatabase(app);
  window.salvarStatusTurma = function () {
  if (!turmaSelecionada) {
    alert("Nenhuma turma selecionada.");
    return;
  }

  const select = document.getElementById("statusTurmaSelect");
  if (!select) return;

  const novoStatus = select.value;
  const turmaId = turmaSelecionada.id;

  const statusRef = ref(db, `turmas/${turmaId}/status`);

  set(statusRef, novoStatus)
    .then(() => {
      // atualiza em mem√≥ria
      turmaSelecionada.status = novoStatus;
      const idx = turmas.findIndex(t => t.id === turmaId);
      if (idx >= 0) {
        turmas[idx].status = novoStatus;
      }

      // redesenha lista para atualizar badge de cor
      renderListaTurmas();

      alert("Status da turma atualizado com sucesso!");
    })
    .catch((err) => {
      console.error("Erro ao atualizar status da turma:", err);
      alert("Erro ao atualizar status. Veja o console para detalhes.");
    });
    };

  const processosDef = [
    { id: "grupo_whats",    titulo: "Grupos / Manual",       campoData: "grupoWhats" },
    { id: "alinhamento_pais", titulo: "Alinhamento pais",    campoData: "alinhamentoPais" },
    { id: "audio_feedback", titulo: "√Åudio + conte√∫dos",     campoData: "audioFeedback" },
    { id: "videos_alunos",  titulo: "V√≠deos alunos",         campoData: "videosAlunos" },
    { id: "rematricula1",   titulo: "1¬™ rematr√≠cula",        campoData: "rematricula1" },
    { id: "mensagem_tcc",   titulo: "Mensagem TCC",          campoData: "mensagemTCC" },
    { id: "bombom_cartao",  titulo: "Bombom c/ cart√£o",      campoData: "bombomCartao" },
    { id: "data_tcc",       titulo: "TCC",                   campoData: "dataTCC" }
  ];

  const turmasRef = ref(db, "turmas");
  const processosRootRef = ref(db, "processos");

  onValue(turmasRef, (snap) => {
    const data = snap.val() || {};
    turmas = Object.entries(data).map(([id, dados]) => ({ id, ...dados }));

    if (turmaSelecionada) {
      const encontrada = turmas.find(t => t.id === turmaSelecionada.id);
      turmaSelecionada = encontrada || null;
    }

    preencherOpcoesHorario();
    renderListaTurmas();

    if (modoPainel === "overview") {
      renderVisaoGeral();
    }
  });

  onValue(processosRootRef, (snap) => {
    statusProcessosFirebase = snap.val() || {};
    if (modoPainel === "overview") {
      renderVisaoGeral();
    }
  });

  function criarBadgeStatus(status) {
    const classe =
      status === "Em andamento" ? "badge-status-andamento" :
      status === "Em forma√ß√£o" ? "badge-status-formacao" :
      "badge-status-encerrada";
    return `<span class="badge ${classe}">${status}</span>`;
  }

  function criarBadgeNivel(nivel) {
    const n = (nivel || "").toLowerCase();
    let classe = "badge-kids";
    if (n === "teens") classe = "badge-teens";
    if (n === "young") classe = "badge-young";
    return `<span class="badge ${classe}">${nivel}</span>`;
  }

  function parseDataBR(str) {
    if (!str) return null;
    const m = String(str).match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
    if (!m) return null;
    const d = parseInt(m[1], 10);
    const mo = parseInt(m[2], 10) - 1;
    const y = parseInt(m[3], 10);
    const date = new Date(y, mo, d);
    if (isNaN(date.getTime())) return null;
    date.setHours(0, 0, 0, 0);
    return date;
  }

  function calcularStatusAutomatico(turma, procId) {
    const def = processosDef.find(p => p.id === procId);
    if (!def) return "neutro";

    const valor = turma[def.campoData];
    const dataProc = parseDataBR(valor);
    if (!dataProc) return "neutro";

    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    const diffDias = Math.round((dataProc - hoje) / (1000 * 60 * 60 * 24));

    if (diffDias < 0)  return "atrasado";
    if (diffDias <= 14) return "embreve";
    return "neutro";
  }

  function getStatusFinal(turma, procId) {
    const tInfo = statusProcessosFirebase[turma.id];
    const reg   = tInfo && tInfo[procId];

    if (reg && (reg.manual || reg.status === "feito")) {
      return reg.status || "neutro";
    }
    return calcularStatusAutomatico(turma, procId);
  }

  window.alterarFiltros = function() {
    filtroNivel   = document.getElementById("filtroNivel").value;
    filtroDia     = document.getElementById("filtroDia").value;
    filtroHorario = document.getElementById("filtroHorario").value;
    filtroStatus  = document.getElementById("filtroStatus").value;

    turmaSelecionada = null;
    if (modoPainel === "turma") {
      document.getElementById("tituloTurma").textContent =
        "Selecione uma turma √† esquerda";
      document.getElementById("botoesAcoes").style.display = "none";
      document.getElementById("conteudoTurma").innerHTML = "";
    }
    renderListaTurmas();
  };

  function preencherOpcoesHorario() {
    const selectHorario = document.getElementById("filtroHorario");
    selectHorario.innerHTML = '<option value="todos">Hor√°rio: todos</option>';
    const horariosUnicos = Array.from(new Set(turmas.map(t => t.horario))).sort();
    horariosUnicos.forEach(h => {
      const opt = document.createElement("option");
      opt.value = h;
      opt.textContent = h;
      selectHorario.appendChild(opt);
    });
  }

  function renderListaTurmas() {
    const lista  = document.getElementById("listaTurmas");
    const header = lista.querySelector(".lista-header");
    lista.innerHTML = "";
    if (header) lista.appendChild(header);

    const filtradas = turmas.filter(t => {
      if (filtroNivel   !== "todos" && t.nivel   !== filtroNivel)   return false;
      if (filtroDia     !== "todos" && t.dia     !== filtroDia)     return false;
      if (filtroHorario !== "todos" && t.horario !== filtroHorario) return false;
      if (filtroStatus  !== "todas" && t.status  !== filtroStatus)  return false;
      return true;
    });

    filtradas.forEach(turma => {
      const div = document.createElement("div");
      div.className = "turma-card";
      div.dataset.id = turma.id;
      div.innerHTML = `
        <div>${criarBadgeStatus(turma.status)} ${criarBadgeNivel(turma.nivel)}</div>
        <div class="turma-nome">${turma.nome}</div>
        <div class="turma-meta">
          Dia: ${turma.dia} ‚Ä¢ Hor√°rio: ${turma.horario}<br>
          Alunos: ${turma.alunos || "-"}<br>
          In√≠cio: ${turma.dataInicio || "-"} ‚Ä¢ T√©rmino: ${turma.dataFim || "-"}<br>
          <button
            class="btn btn-perigo"
            style="margin-top: 6px; font-size:0.75rem; padding:4px 8px;"
            onclick="excluirTurmaSelecionada('${turma.id}', event)">
            Excluir turma
          </button>
        </div>`;
      div.addEventListener("click", () => selecionarTurma(turma.id));
      lista.appendChild(div);
    });

    if (filtradas.length === 0) {
      const vazio = document.createElement("div");
      vazio.style.fontSize = "0.85rem";
      vazio.style.color = "#6b7280";
      vazio.style.marginTop = "8px";
      vazio.textContent = "Nenhuma turma encontrada com esses filtros.";
      lista.appendChild(vazio);
    }
  }

  function selecionarTurma(id) {
    turmaSelecionada = turmas.find(t => t.id === id);
    document.querySelectorAll(".turma-card").forEach(card => {
      card.classList.toggle("selecionada", card.dataset.id === id);
    });

    if (modoPainel === "turma") {
      const titulo   = document.getElementById("tituloTurma");
      const botoes   = document.getElementById("botoesAcoes");
      const conteudo = document.getElementById("conteudoTurma");

      titulo.textContent = `Turma selecionada: ${turmaSelecionada.nome}`;
      botoes.style.display = "flex";
      conteudo.innerHTML =
        `<p>Escolha uma op√ß√£o acima: <strong>Acompanhar turma</strong> ou <strong>Processos da turma</strong>.</p>`;
    }
  }
  window.selecionarTurma = selecionarTurma;

  window.setModoPainel = function(modo) {
    modoPainel = modo;
    const tabTurma    = document.getElementById("tabTurma");
    const tabOverview = document.getElementById("tabOverview");
    tabTurma.classList.toggle("tab-ativa", modo === "turma");
    tabOverview.classList.toggle("tab-ativa", modo === "overview");

    const titulo   = document.getElementById("tituloTurma");
    const botoes   = document.getElementById("botoesAcoes");
    const conteudo = document.getElementById("conteudoTurma");

    if (modo === "overview") {
      botoes.style.display = "none";
      titulo.textContent = "Vis√£o geral dos processos";
      renderVisaoGeral();
    } else {
      if (turmaSelecionada) {
        titulo.textContent = `Turma selecionada: ${turmaSelecionada.nome}`;
        botoes.style.display = "flex";
        conteudo.innerHTML =
          `<p>Escolha uma op√ß√£o acima: <strong>Acompanhar turma</strong> ou <strong>Processos da turma</strong>.</p>`;
      } else {
        titulo.textContent = "Selecione uma turma √† esquerda";
        botoes.style.display = "none";
        conteudo.innerHTML = "";
      }
    }
  };

  window.mostrarSecao = function(tipo) {
    if (!turmaSelecionada) return;
    const conteudo = document.getElementById("conteudoTurma");

    if (tipo === "acompanhar") {
      conteudo.innerHTML = `
      <h3>üìä Acompanhar turma</h3>

      <div class="linha-info">
        <span class="campo-label"><strong>Status</strong></span>
        <span class="campo-valor">
          <select id="statusTurmaSelect" style="padding:2px 6px; font-size:0.85rem;">
            <option value="Em andamento" ${turmaSelecionada.status === "Em andamento" ? "selected" : ""}>Em andamento</option>
            <option value="Em forma√ß√£o"  ${turmaSelecionada.status === "Em forma√ß√£o"  ? "selected" : ""}>Em forma√ß√£o</option>
            <option value="Encerrada"    ${turmaSelecionada.status === "Encerrada"    ? "selected" : ""}>Encerrada</option>
          </select>
          <button
            type="button"
            class="btn btn-primario"
            style="margin-left:6px; padding:4px 10px; font-size:0.8rem;"
            onclick="salvarStatusTurma()">
            Salvar
          </button>
        </span>
      </div>

      <div class="linha-info"><span class="campo-label">N√≠vel</span><span class="campo-valor">${turmaSelecionada.nivel}</span></div>
      <div class="linha-info"><span class="campo-label">Dia / hor√°rio</span><span class="campo-valor">${turmaSelecionada.dia} ‚Ä¢ ${turmaSelecionada.horario}</span></div>
      <div class="linha-info"><span class="campo-label">Alunos</span><span class="campo-valor">${turmaSelecionada.alunos || "-"}</span></div>
      <div class="linha-info"><span class="campo-label">Data de in√≠cio</span><span class="campo-valor">${turmaSelecionada.dataInicio || "-"}</span></div>
      <div class="linha-info"><span class="campo-label">Pausa</span><span class="campo-valor">${turmaSelecionada.dataPausa || "-"}</span></div>
      <div class="linha-info"><span class="campo-label">Per√≠odo de f√©rias</span><span class="campo-valor">${turmaSelecionada.periodoFerias || "-"}</span></div>
      <div class="linha-info"><span class="campo-label">Retorno</span><span class="campo-valor">${turmaSelecionada.dataRetorno || "-"}</span></div>
      <div class="linha-info"><span class="campo-label">T√©rmino</span><span class="campo-valor">${turmaSelecionada.dataFim || "-"}</span></div>
      <div class="linha-info"><span class="campo-label">Total de aulas</span><span class="campo-valor">${turmaSelecionada.totalAulas || "-"}</span></div>
      <div class="linha-info"><span class="campo-label">Pr√≥ximo m√≥dulo</span><span class="campo-valor">${turmaSelecionada.proximoModulo || "-"}</span></div>
    `;
    } else if (tipo === "processos") {
      conteudo.innerHTML = `
        <h3>‚öôÔ∏è Processos da turma</h3>
        <p style="font-size:0.8rem; color:#6b7280; margin-bottom:8px;">
          Clique em cada processo para mudar o status: neutro ‚Üí em breve ‚Üí atrasado ‚Üí feito.
        </p>
        <div class="processos-grid">
          ${criarCardProcesso("grupo_whats", "Grupos de WhatsApp + manual", turmaSelecionada.grupoWhats)}
          ${criarCardProcesso("alinhamento_pais", "Alinhamento com os pais", turmaSelecionada.alinhamentoPais)}
          ${criarCardProcesso("audio_feedback", "√Åudio de feedback + conte√∫dos", turmaSelecionada.audioFeedback)}
          ${criarCardProcesso("videos_alunos", "V√≠deos dos alunos", turmaSelecionada.videosAlunos)}
          ${criarCardProcesso("rematricula1", "1¬™ mensagem de rematr√≠cula", turmaSelecionada.rematricula1)}
          ${criarCardProcesso("mensagem_tcc", "Mensagem sobre o TCC", turmaSelecionada.mensagemTCC)}
          ${criarCardProcesso("bombom_cartao", "Bombom com cart√£o", turmaSelecionada.bombomCartao)}
          ${criarCardProcesso("data_tcc", "Data da apresenta√ß√£o do TCC", turmaSelecionada.dataTCC)}
        </div>
      `;
      inicializarProcessosClicaveis();
    }
  };

  function criarCardProcesso(idProc, titulo, subtitulo) {
    return `
      <div class="processo-card status-neutro" data-status="neutro"
           data-key="${turmaSelecionada.id}::${idProc}">
        <div class="processo-titulo">${titulo}</div>
        <div class="processo-sub">${subtitulo || "-"}</div>
        <div class="processo-status-label">Status: Neutro</div>
      </div>`;
  }

  function aplicarEstadoNoCard(card, estado) {
    if (!cicloStatusProcesso.includes(estado)) estado = "neutro";
    card.dataset.status = estado;
    cicloStatusProcesso.forEach(s => card.classList.remove("status-" + s));
    card.classList.add("status-" + estado);

    const label = card.querySelector(".processo-status-label");
    if (label) label.textContent = "Status: " + statusLabelMap[estado];
  }

  function inicializarProcessosClicaveis() {
  const cards = document.querySelectorAll(".processo-card");

  cards.forEach(card => {
    const [turmaId, procId] = card.dataset.key.split("::");
    const turmaObj = turmas.find(t => t.id === turmaId);
    const estadoInicial = getStatusFinal(turmaObj, procId);
    aplicarEstadoNoCard(card, estadoInicial);

    const caminhoRef = ref(db, `processos/${turmaId}/${procId}`);

    // üëâ clique no card inteiro = mudar STATUS (neutro ‚Üí em breve ‚Üí atrasado ‚Üí feito)
    card.addEventListener("click", () => {
      let atual = card.dataset.status || "neutro";
      let i = cicloStatusProcesso.indexOf(atual);
      let proximo = cicloStatusProcesso[(i + 1) % cicloStatusProcesso.length];

      aplicarEstadoNoCard(card, proximo);
      // grava como manual
      set(caminhoRef, { status: proximo, manual: true });
    });

    // üëâ clique NA DATA (subt√≠tulo) = editar data do processo
    const subEl = card.querySelector(".processo-sub");
    if (subEl) {
      subEl.style.textDecoration = "underline";
      subEl.style.cursor = "pointer";
      subEl.title = "Clique para editar a data";

      subEl.addEventListener("click", (ev) => {
        // n√£o deixa o clique na data disparar o clique do card (que mudaria o status)
        ev.stopPropagation();

        const def = processosDef.find(p => p.id === procId);
        if (!def) return;
        const campo = def.campoData; // ex: "grupoWhats", "audioFeedback" etc.

        const valorAtual = turmaObj[campo] || "";
        const novoValor = prompt(
          "Digite a data no formato dd/mm/aaaa (ou deixe vazio para limpar):",
          valorAtual
        );
        if (novoValor === null) return; // cancelou

        const novo = novoValor.trim();

        const turmaCampoRef = ref(db, `turmas/${turmaId}/${campo}`);
        set(turmaCampoRef, novo)
          .then(() => {
            // atualiza em mem√≥ria
            turmaObj[campo] = novo;
            subEl.textContent = novo || "-";

            // recalcula o status autom√°tico (se n√£o tiver override manual de "feito")
            const novoStatus = getStatusFinal(turmaObj, procId);
            aplicarEstadoNoCard(card, novoStatus);
          })
          .catch(err => {
            console.error("Erro ao atualizar data do processo:", err);
            alert("Erro ao salvar a data. Veja o console para detalhes.");
          });
      });
    }
  });
}


  function renderVisaoGeral() {
    const conteudo = document.getElementById("conteudoTurma");
    let html = `
      <h3>üìã Vis√£o geral dos processos</h3>
      <p style="font-size:0.8rem;color:#6b7280;margin-bottom:6px;">
        Verde = feito (manual) ‚Ä¢ Laranja = em breve (at√© 14 dias) ‚Ä¢ Vermelho = atrasado ‚Ä¢ Branco = neutro.
      </p>
      <div style="overflow-x:auto;">
        <table class="tabela-visao-geral">
          <thead>
            <tr>
              <th>Turma</th>`;

    processosDef.forEach(p => {
      html += `<th>${p.titulo}</th>`;
    });

    html += `</tr></thead><tbody>`;

    turmas.forEach(turma => {
      html += `<tr><td class="col-turma">${turma.nome}</td>`;
      processosDef.forEach(p => {
        const status = getStatusFinal(turma, p.id);
        const valor  = turma[p.campoData] || "-";
        html += `<td class="cel-processo status-${status}">${valor}</td>`;
      });
      html += `</tr>`;
    });

    html += `</tbody></table></div>`;
    conteudo.innerHTML = html;
  }

  // inicial
  setModoPainel("turma");
</script>

  <!-- FORMUL√ÅRIO DE CRIA√á√ÉO DE NOVA TURMA -->
<div id="novaTurmaContainer"
     style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:50; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:12px; padding:16px; width:100%; max-width:420px; box-shadow:0 10px 30px rgba(0,0,0,0.3);">
    <h3 style="margin-top:0; margin-bottom:8px;">Nova turma</h3>
    <p style="font-size:0.8rem; color:#6b7280; margin-top:0;">
      Preencha os dados b√°sicos da turma. Voc√™ define o ID (por exemplo: 6761, 7117...).
    </p>

    <div style="display:flex; flex-direction:column; gap:6px; font-size:0.85rem;">
      <label>
        ID da turma
        <input id="novaTurmaId" type="text"
               style="width:100%; padding:4px 6px; border-radius:6px; border:1px solid #d1d5db;">
      </label>

      <label>
        Nome da turma
        <input id="novaTurmaNome" type="text"
               placeholder="Ex: Teens 1 - Quinta - 18:30 √†s 20:30"
               style="width:100%; padding:4px 6px; border-radius:6px; border:1px solid #d1d5db;">
      </label>

      <label>
        N√≠vel
        <select id="novaTurmaNivel"
                style="width:100%; padding:4px 6px; border-radius:6px; border:1px solid #d1d5db;">
          <option value="Kids">Kids</option>
          <option value="Teens">Teens</option>
          <option value="Young">Young</option>
        </select>
      </label>

      <label>
        Dia
        <select id="novaTurmaDia"
                style="width:100%; padding:4px 6px; border-radius:6px; border:1px solid #d1d5db;">
          <option value="Segunda">Segunda</option>
          <option value="Ter√ßa">Ter√ßa</option>
          <option value="Quarta">Quarta</option>
          <option value="Quinta">Quinta</option>
          <option value="Sexta">Sexta</option>
          <option value="S√°bado">S√°bado</option>
        </select>
      </label>

      <label>
        Hor√°rio (in√≠cio)
        <input id="novaTurmaHorario" type="text"
               placeholder="Ex: 18:30"
               style="width:100%; padding:4px 6px; border-radius:6px; border:1px solid #d1d5db;">
      </label>

      <label>
        Status
        <select id="novaTurmaStatus"
                style="width:100%; padding:4px 6px; border-radius:6px; border:1px solid #d1d5db;">
          <option value="Em andamento">Em andamento</option>
          <option value="Em forma√ß√£o">Em forma√ß√£o</option>
          <option value="Encerrada">Encerrada</option>
        </select>
      </label>

      <label>
        N¬∫ de alunos (opcional)
        <input id="novaTurmaAlunos" type="number" min="0"
               style="width:100%; padding:4px 6px; border-radius:6px; border:1px solid #d1d5db;">
      </label>

      <label>
        Data de in√≠cio (opcional)
        <input id="novaTurmaDataInicio" type="text" placeholder="dd/mm/aaaa"
               style="width:100%; padding:4px 6px; border-radius:6px; border:1px solid #d1d5db;">
      </label>

      <label>
        Data de t√©rmino (opcional)
        <input id="novaTurmaDataFim" type="text" placeholder="dd/mm/aaaa"
               style="width:100%; padding:4px 6px; border-radius:6px; border:1px solid #d1d5db;">
      </label>
    </div>

    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
      <button class="btn btn-secundario" type="button" onclick="fecharFormularioNovaTurma()">
        Cancelar
      </button>
      <button class="btn btn-primario" type="button" onclick="salvarNovaTurma()">
        Salvar turma
      </button>
    </div>
  </div>
</div>

</body>

</html>
