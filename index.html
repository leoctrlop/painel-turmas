<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Turmas</title>
  <style>
  /* =========================
     BASE
     ========================= */
  * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }

  /* =========================
     SCHEDULE GRID (altura proporcional por dura√ß√£o)
     ========================= */

  /* ===== SCHEDULE GRID WRAP ===== */
  .schedule-grid-wrap{
    overflow: auto;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: var(--panel);
  }

  /* ===== GRID ===== */
  .schedule-grid{
    display:grid;
    grid-template-columns: 92px repeat(6, minmax(210px, 1fr));
    grid-template-rows: 44px;   /* ‚úÖ header */
    grid-auto-rows: 44px;       /* ‚úÖ cada slot = 44px */
    gap: 0;
    min-width: 1100px;
    position: relative;
  }

  /* header */
  .sg-head{
    position: sticky;
    top: 0;
    z-index: 20;
    background: var(--thead);
    border-bottom: 1px solid var(--border);
    padding: 10px 8px;
    font-weight: 700;
    height: 44px;
    display: flex;
    align-items: center;
  }

  .sg-head.time{
    position: sticky;
    left: 0;
    z-index: 30;
    background: var(--thead);
    border-right: 1px solid var(--border);
  }

  /* coluna de hor√°rio */
  .sg-time{
    position: sticky;
    left: 0;
    z-index: 10;
    background: var(--col-bg);
    border-right: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
    padding: 8px;
    font-weight: 700;
    white-space: nowrap;
    height: 44px;
    display:flex;
    align-items:center;
  }

  /* slots vazios */
  .sg-cell{
    border-bottom: 1px solid var(--border);
    border-right: 1px solid var(--border);
    min-height: 44px;
    background: transparent;
    z-index: 1;
  }

  /* overlay do dia (onde entram os cards) */
  .sg-day-layer{
    position: relative;
    z-index: 5;
    pointer-events: none;
  }

  /* card */
  .sg-class{
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--card);
    padding: 10px;
    box-shadow: var(--shadow);
    cursor: pointer;
    overflow: hidden;
    transition: 0.12s ease;
  }
  .sg-class:hover{ transform: translateY(-1px); }

  /* =========================
     THEME TOKENS (light/dark)
     ========================= */
  :root{
    --bg: #f4f4f8;
    --text: #222;

    --panel: #ffffff;
    --card: #ffffff;

    --muted: #555;
    --muted2: #6b7280;

    --border: #e5e7eb;
    --border2: #ddd;

    --shadow: 0 2px 6px rgba(0,0,0,0.08);

    --hover: #f0f7ff;
    --selected: #e0edff;
    --selected-border: #2563eb;

    --input-bg: #f9fafb;
    --input-border: #d1d5db;

    --tab-bg: #e5e7eb;
    --tab-text: #111827;

    --thead: #f3f4f6;
    --col-bg: #f9fafb;
  }

  html[data-theme="dark"]{
    --bg: #0b1220;
    --text: #e5e7eb;

    --panel: #0f172a;
    --card: #111c33;

    --muted: #a1a1aa;
    --muted2: #9ca3af;

    --border: #243049;
    --border2: #2a3856;

    --shadow: 0 10px 26px rgba(0,0,0,0.35);

    --hover: rgba(37, 99, 235, 0.18);
    --selected: rgba(37, 99, 235, 0.22);
    --selected-border: #60a5fa;

    --input-bg: #0b1220;
    --input-border: #2a3856;

    --tab-bg: #1f2a44;
    --tab-text: #e5e7eb;

    --thead: #14203a;
    --col-bg: #0b1220;
  }

  body { margin: 0; padding: 20px; background: var(--bg); color: var(--text); }
  h1 { text-align: center; margin-bottom: 20px; }

  .layout { display: grid; grid-template-columns: 1.2fr 1.8fr; gap: 20px; align-items: flex-start; }

  .lista-header { display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
  .lista-header-title { font-weight: 600; font-size: 0.95rem; }
  .filtros-row { display: flex; flex-wrap: wrap; gap: 6px; }

  /* ‚úÖ filtros com texto leg√≠vel no dark */
  .filtro-select{
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid var(--input-border);
    font-size: 0.8rem;
    background: var(--input-bg);
    color: var(--text) !important;
  }

  html[data-theme="dark"] .filtro-select option{
    background: var(--panel) !important;
    color: var(--text) !important;
  }

  .turma-lista {
    background: var(--panel); border-radius: 12px; padding: 15px;
    box-shadow: var(--shadow); max-height: 80vh; overflow-y: auto;
  }
  .turma-card {
    border-radius: 10px; padding: 10px 12px; margin-bottom: 8px; cursor: pointer;
    border: 1px solid var(--border2); display: flex; flex-direction: column; gap: 4px;
    transition: 0.15s ease;
    background: var(--card);
  }
  .turma-card:hover { background: var(--hover); transform: translateY(-1px); }
  .turma-card.selecionada { border-color: var(--selected-border); background: var(--selected); }
  .turma-nome { font-weight: 600; font-size: 0.95rem; }
  .turma-meta { font-size: 0.8rem; color: var(--muted); }

  .badge {
    display: inline-block; font-size: 0.75rem; padding: 2px 8px;
    border-radius: 999px; color: #fff; margin-right: 4px;
  }
  .badge-status-andamento { background: #16a34a; }
  .badge-status-formacao { background: #eab308; }
  .badge-status-encerrada { background: #dc2626; }

  .badge-kids { background: #3b82f6; }
  .badge-teens { background: #f97316; }
  .badge-young { background: #a855f7; }

  .painel {
    background: var(--panel); border-radius: 12px; padding: 16px;
    box-shadow: var(--shadow);
    min-height: 200px; display: flex; flex-direction: column; gap: 10px;
  }

  /* abas do painel */
  .painel-tabs { display: flex; gap: 6px; margin-bottom: 4px; }
  .tab-btn {
    border: none; border-radius: 999px;
    background: var(--tab-bg); color: var(--tab-text);
    padding: 4px 10px; font-size: 0.8rem;
    cursor: pointer; transition: 0.15s;
  }
  .tab-btn.tab-ativa { background: #2563eb; color: #fff; }
  .tab-btn:hover { filter: brightness(0.95); }

  .painel-titulo { font-size: 1.05rem; font-weight: 600; }

  .painel-botoes { display: flex; gap: 10px; margin-top: 4px; }

  .btn {
    border: none; border-radius: 999px; padding: 8px 16px; font-size: 0.9rem;
    cursor: pointer; display: inline-flex; align-items: center;
    justify-content: center; gap: 6px; transition: 0.15s ease;
  }
  .btn-primario { background: #2563eb; color: #fff; }
  .btn-secundario { background: var(--tab-bg); color: var(--tab-text); }
  .btn:hover { filter: brightness(0.95); transform: translateY(-0.5px); }

  .btn-perigo { background:#dc2626; color:#fff; }
  .btn-perigo:hover { filter: brightness(0.95); }

  .conteudo { margin-top: 6px; border-top: 1px solid var(--border); padding-top: 10px; font-size: 0.9rem; }
  .conteudo h3 { margin-top: 0; margin-bottom: 8px; }

  .linha-info {
    display: flex; justify-content: space-between;
    padding: 4px 0; border-bottom: 1px dashed var(--border);
  }
  .campo-label { color: var(--muted2); }
  .campo-valor { font-weight: 500; color: var(--text); margin-left: 8px; }

  .processos-grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
  .processo-card {
    border-radius: 10px; border: 1px solid var(--border);
    padding: 8px 10px; cursor: pointer; transition: 0.15s ease;
    background: var(--card);
  }
  .processo-card:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.06); }
  .processo-titulo { font-weight: 500; margin-bottom: 3px; }
  .processo-sub { font-size: 0.8rem; color: var(--muted2); margin-bottom: 4px; }
  .processo-status-label { font-size: 0.8rem; font-weight: 500; }

  /* status */
  .status-neutro { background: #ffffff; color: #111827; }
  .status-embreve { background: #fef3c7; color: #7c2d12; }
  .status-atrasado { background: #fee2e2; color: #7f1d1d; }
  .status-feito { background: #dcfce7; color: #065f46; }

  /* vis√£o geral em tabela */
  .tabela-visao-geral {
    border-collapse: collapse;
    width: 100%;
    font-size: 0.8rem;
  }
  .tabela-visao-geral th,
  .tabela-visao-geral td {
    border: 1px solid var(--border);
    padding: 4px 6px;
  }
  .tabela-visao-geral th {
    background: var(--thead);
    position: sticky;
    top: 0;
    z-index: 1;
    font-weight: 600;
    color: var(--text);
  }

  .col-turma {
    text-align: left;
    white-space: nowrap;
    font-weight: 600;
    background: var(--col-bg);
    color: var(--text) !important;
  }

  .cel-processo {
    text-align: center;
    min-width: 90px;
    color: var(--text);
    cursor: pointer;
    user-select: none;
  }

  /* ===== QUADRO DE HOR√ÅRIOS (controle) ===== */
  .schedule-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    justify-content: space-between;
    margin: 6px 0 10px 0;
    padding: 8px 10px;
    border: 1px solid var(--border);
    border-radius: 10px;
    background: var(--col-bg);
  }

  .schedule-controls .left {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  .chk {
    display: inline-flex;
    gap: 8px;
    align-items: center;
    font-size: 0.85rem;
    color: var(--text);
    cursor: pointer;
    user-select: none;
  }

  .chk input { transform: translateY(1px); }

  .slot-title {
    font-weight: 700;
    line-height: 1.15;
    margin-top: 4px;
    color: var(--text);
  }

  .slot-sub {
    font-size: 0.78rem;
    color: var(--muted2);
    margin-top: 2px;
  }

  .slot-andamento { border-left: 6px solid #16a34a; }
  .slot-formacao  { border-left: 6px solid #eab308; }

  @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }

  html[data-theme="dark"] .status-neutro{
    background: rgba(255,255,255,0.04) !important;
    color: #e5e7eb !important;
  }
  html[data-theme="dark"] .status-embreve{
    background: rgba(234,179,8,0.18) !important;
    color: #fde68a !important;
  }
  html[data-theme="dark"] .status-atrasado{
    background: rgba(220,38,38,0.18) !important;
    color: #fecaca !important;
  }
  html[data-theme="dark"] .status-feito{
    background: rgba(34,197,94,0.18) !important;
    color: #bbf7d0 !important;
  }
  html[data-theme="dark"] .tabela-visao-geral td{
    color: #e5e7eb;
  }
  /* =========================
   FULLSCREEN no modo schedule
   ========================= */
  .layout.modo-schedule{
    grid-template-columns: 1fr !important;   /* painel ocupa tudo */
  }

  .layout.modo-schedule .turma-lista{
    display: none !important;               /* some com a lista da esquerda */
  }

  .layout.modo-schedule .painel{
    min-height: calc(100vh - 120px);        /* opcional: mais alto */
  }

  /* (opcional) d√° uma ‚Äúesticada‚Äù geral no wrap do quadro */
  .layout.modo-schedule #conteudoTurma{
    margin-top: 6px;
  }

</style>

</head>

<body>
  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:20px;">
    <h1 style="margin:0; flex:1; text-align:center;">Painel de Turmas</h1>
    <button id="themeToggle" class="theme-toggle" type="button" aria-label="Alternar modo noturno">
      üåô
    </button>
  </div>

  <div class="layout">
    <!-- Lista de Turmas -->
    <div class="turma-lista" id="listaTurmas">
      <div class="lista-header">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
          <div class="lista-header-title">Turmas</div>
          <button
            class="btn btn-primario"
            style="padding:4px 10px; font-size:0.8rem;"
            onclick="abrirFormularioNovaTurma()">
            + Nova turma
          </button>
        </div>

        <div class="filtros-row">
          <select id="filtroNivel" class="filtro-select" onchange="alterarFiltros()">
            <option value="todos">N√≠vel: todos</option>
            <option value="Kids">Kids</option>
            <option value="Teens">Teens</option>
            <option value="Young">Young</option>
          </select>

          <select id="filtroDia" class="filtro-select" onchange="alterarFiltros()">
            <option value="todos">Dia: todos</option>
            <option value="Segunda">Segunda</option>
            <option value="Ter√ßa">Ter√ßa</option>
            <option value="Quarta">Quarta</option>
            <option value="Quinta">Quinta</option>
            <option value="Sexta">Sexta</option>
            <option value="S√°bado">S√°bado</option>
          </select>

          <select id="filtroHorario" class="filtro-select" onchange="alterarFiltros()">
            <option value="todos">Hor√°rio: todos</option>
          </select>

          <select id="filtroStatus" class="filtro-select" onchange="alterarFiltros()">
            <option value="todas">Status: todos</option>
            <option value="Em andamento">Em andamento</option>
            <option value="Em forma√ß√£o">Em forma√ß√£o</option>
            <option value="Encerrada">Encerrada</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Painel -->
    <div class="painel">
      <div class="painel-tabs">
        <button id="tabTurma" class="tab-btn tab-ativa" onclick="setModoPainel('turma')">
          Painel por turma
        </button>
        <button id="tabOverview" class="tab-btn" onclick="setModoPainel('overview')">
          Vis√£o geral dos processos
        </button>
        <button id="tabSchedule" class="tab-btn" onclick="setModoPainel('schedule')">
          Quadro de hor√°rios
        </button>
      </div>

      <div class="painel-titulo" id="tituloTurma">
        Selecione uma turma √† esquerda
      </div>

      <div class="painel-botoes" id="botoesAcoes" style="display:none;">
        <button class="btn btn-primario" onclick="mostrarSecao('acompanhar')">
          üìä Acompanhar turma
        </button>
        <button class="btn btn-secundario" onclick="mostrarSecao('processos')">
          ‚öôÔ∏è Processos da turma
        </button>
      </div>

      <div class="conteudo" id="conteudoTurma"></div>
    </div>
  </div>

  <!-- SCRIPT COM FIREBASE + L√ìGICA -->
  <script type="module">
    // =========================
    // THEME (light/dark)
    // =========================
    function applyTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
      const btn = document.getElementById("themeToggle");
      if (btn) btn.textContent = (theme === "dark") ? "‚òÄÔ∏è" : "üåô";
    }
    function getPreferredTheme(){
      const saved = localStorage.getItem("theme");
      if (saved === "dark" || saved === "light") return saved;
      return (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) ? "dark" : "light";
    }
    const initialTheme = getPreferredTheme();
    applyTheme(initialTheme);

    window.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("themeToggle");
      if (!btn) return;
      btn.addEventListener("click", () => {
        const cur = document.documentElement.getAttribute("data-theme") || "light";
        const next = (cur === "dark") ? "light" : "dark";
        localStorage.setItem("theme", next);
        applyTheme(next);
      });
    });

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // ====== STATE ======
    let turmas = [];
    let turmaSelecionada = null;
    let modoPainel = "turma";
    let filtroNivel = "todos";
    let filtroDia = "todos";
    let filtroHorario = "todos";
    let filtroStatus = "todas";
    let mostrarFormacaoNoHorario = true;

    function escapeHTML(v) {
      return String(v ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // ====== Datas (BR/ISO) ======
    function parseDateBRorISO(s) {
      if (!s) return null;
      s = String(s).trim();

      // ISO: YYYY-MM-DD
      let m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (m) {
        const d = new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
        d.setHours(0,0,0,0);
        return d;
      }

      // BR: DD/MM/YYYY
      m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (m) {
        const d = new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]));
        d.setHours(0,0,0,0);
        return d;
      }

      return null;
    }

    function dateToISO(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function isoToBR(iso) {
      const d = parseDateBRorISO(iso);
      if (!d) return "";
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }

    // valida dd/mm/aaaa ‚Äúestrito‚Äù
    function parseDataBR(str) {
      if (!str) return null;
      const m = String(str).match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (!m) return null;
      const d = parseInt(m[1], 10);
      const mo = parseInt(m[2], 10) - 1;
      const y = parseInt(m[3], 10);
      const date = new Date(y, mo, d);
      if (isNaN(date.getTime())) return null;
      date.setHours(0, 0, 0, 0);
      if (date.getFullYear() !== y || date.getMonth() !== mo || date.getDate() !== d) return null;
      return date;
    }

    function parseWeekdayPT(dia) {
      const map = {
        "Segunda": 1,
        "Ter√ßa": 2, "Terca": 2,
        "Quarta": 3,
        "Quinta": 4,
        "Sexta": 5,
        "S√°bado": 6, "Sabado": 6
      };
      return map[dia] ?? null;
    }

    function nextWeekdayOnOrAfter(d, targetJsWeekday) {
      const cur = d.getDay();
      const delta = (targetJsWeekday - cur + 7) % 7;
      const nd = new Date(d);
      nd.setDate(d.getDate() + delta);
      nd.setHours(0,0,0,0);
      return nd;
    }

    function normalizeExclusions(excludedList = []) {
      const single = new Set();
      const ranges = [];

      for (const item of excludedList) {
        if (Array.isArray(item) && item.length === 2) {
          const d1 = parseDateBRorISO(item[0]);
          const d2 = parseDateBRorISO(item[1]);
          if (!d1 || !d2) continue;
          const a = d1 <= d2 ? d1 : d2;
          const b = d1 <= d2 ? d2 : d1;
          ranges.push([dateToISO(a), dateToISO(b)]);
        } else {
          const d = parseDateBRorISO(item);
          if (!d) continue;
          single.add(dateToISO(d));
        }
      }
      return { single, ranges };
    }

    function inAnyRangeISO(iso, ranges) {
      return ranges.some(([a,b]) => a <= iso && iso <= b);
    }

    function genValidClassDaysISO({ startDateStr, diaSemanaPT, count, excludedList = [] }) {
      const start = parseDateBRorISO(startDateStr);
      const wd = parseWeekdayPT(diaSemanaPT);
      if (!start || wd === null) return { datesISO: [], skipped: [] };

      const { single, ranges } = normalizeExclusions(excludedList);

      let cur = nextWeekdayOnOrAfter(start, wd);
      const datesISO = [];
      const skipped = [];

      while (datesISO.length < count) {
        const iso = dateToISO(cur);

        let reason = null;
        if (single.has(iso)) reason = "feriado/data pontual";
        else if (inAnyRangeISO(iso, ranges)) reason = "per√≠odo (recesso/f√©rias)";

        if (reason) skipped.push(`Pulou ${iso} (${reason})`);
        else datesISO.push(iso);

        cur = new Date(cur);
        cur.setDate(cur.getDate() + 7);
        cur.setHours(0,0,0,0);
      }

      return { datesISO, skipped };
    }

    function calcularProcessosPorAulas(datesISO) {
      const n = datesISO.length;
      const get = (aulaN) => (aulaN >= 1 && aulaN <= n) ? isoToBR(datesISO[aulaN - 1]) : "";
      return {
        grupoWhats:       get(2),
        alinhamentoPais:  get(4),
        audioFeedback:    get(9),
        videosAlunos:     get(14),
        rematricula1:     get(n - 4),
        mensagemTCC:      get(n - 1),
        bombomCartao:     get(n),
        dataTCC:          get(n),
      };
    }

    const EXCLUSOES_PADRAO = [
      ["2025-12-13", "2026-02-06"],
      ["2026-07-05", "2026-08-02"],
      "2025-11-15",
      "2025-11-20",
      "2025-12-08",
      "2026-06-04",
      "2026-09-07",
      ["2026-10-12","2026-10-15"],
    ];

    // ===== hor√°rio (robusto) =====
    function extrairMinutosHorario(valor) {
      if (!valor) return null;
      const s = String(valor);
      const m = s.match(/(\d{1,2})\s*(?:[:h])\s*(\d{2})/i);
      if (!m) return null;

      const hh = Number(m[1]);
      const mm = Number(m[2]);
      if (!Number.isFinite(hh) || !Number.isFinite(mm)) return null;
      if (hh < 0 || hh > 23 || mm < 0 || mm > 59) return null;

      return hh * 60 + mm;
    }

    function extrairIntervaloHorario(valor) {
      if (!valor) return { start: null, end: null };
      const s = String(valor);

      const matches = [...s.matchAll(/(\d{1,2})\s*(?:[:h])\s*(\d{2})/gi)];
      if (matches.length === 0) return { start: null, end: null };

      const toMin = (mm) => {
        const h = Number(mm[1]), m = Number(mm[2]);
        if (!Number.isFinite(h) || !Number.isFinite(m)) return null;
        if (h < 0 || h > 23 || m < 0 || m > 59) return null;
        return h * 60 + m;
      };

      const start = toMin(matches[0]);
      const end = matches.length >= 2 ? toMin(matches[1]) : null;
      return { start, end };
    }

    function formatarHora(min) {
      const hh = String(Math.floor(min / 60)).padStart(2, "0");
      const mm = String(min % 60).padStart(2, "0");
      return `${hh}:${mm}`;
    }

    // ===== Valida√ß√µes =====
    function validarIdTurma(id) { return /^[0-9]{3,10}$/.test(id); }
    function validarHorario(h) { return /^([01]\d|2[0-3]):([0-5]\d)$/.test(String(h || "").trim()); }

    function parseHHMMToMin(h){
      const m = String(h || "").trim().match(/^(\d{1,2}):(\d{2})$/);
      if (!m) return null;
      const hh = parseInt(m[1], 10);
      const mm = parseInt(m[2], 10);
      if (isNaN(hh) || isNaN(mm) || hh < 0 || hh > 23 || mm < 0 || mm > 59) return null;
      return hh * 60 + mm;
    }

    function minToHHMM(min){
      min = ((min % 1440) + 1440) % 1440;
      const hh = String(Math.floor(min / 60)).padStart(2, "0");
      const mm = String(min % 60).padStart(2, "0");
      return `${hh}:${mm}`;
    }

    // ===== CONFIG FIREBASE =====
    const firebaseConfig = {
      apiKey: "SUA_API_KEY",
      authDomain: "SEU_DOMINIO.firebaseapp.com",
      databaseURL: "https://painel-turmas-7a2e5-default-rtdb.firebaseio.com",
      projectId: "SEU_PROJECT_ID",
      storageBucket: "SEU_BUCKET.appspot.com",
      messagingSenderId: "SEU_SENDER_ID",
      appId: "SEU_APP_ID"
    };
    const app  = initializeApp(firebaseConfig);
    const db   = getDatabase(app);

    // ===== Defini√ß√µes de processos =====
    const processosDef = [
      { id: "grupo_whats",      titulo: "Grupos / Manual",       campoData: "grupoWhats" },
      { id: "alinhamento_pais", titulo: "Alinhamento pais",      campoData: "alinhamentoPais" },
      { id: "audio_feedback",   titulo: "√Åudio + conte√∫dos",     campoData: "audioFeedback" },
      { id: "videos_alunos",    titulo: "V√≠deos alunos",         campoData: "videosAlunos" },
      { id: "rematricula1",     titulo: "1¬™ rematr√≠cula",        campoData: "rematricula1" },
      { id: "mensagem_tcc",     titulo: "Mensagem TCC",          campoData: "mensagemTCC" },
      { id: "bombom_cartao",    titulo: "Bombom c/ cart√£o",      campoData: "bombomCartao" },
      { id: "data_tcc",         titulo: "TCC",                   campoData: "dataTCC" }
    ];

    const cicloStatusProcesso = ["neutro", "embreve", "atrasado", "feito"];
    const statusLabelMap = { neutro:"Neutro", embreve:"Em breve", atrasado:"Atrasado", feito:"Feito" };
    let statusProcessosFirebase = {};

    // ===== badges =====
    function criarBadgeStatus(status) {
      const classe =
        status === "Em andamento" ? "badge-status-andamento" :
        status === "Em forma√ß√£o" ? "badge-status-formacao" :
        "badge-status-encerrada";
      return `<span class="badge ${classe}">${escapeHTML(status)}</span>`;
    }

    function criarBadgeNivel(nivel) {
      const n = (nivel || "").toLowerCase();
      let classe = "badge-kids";
      if (n === "teens") classe = "badge-teens";
      if (n === "young") classe = "badge-young";
      return `<span class="badge ${classe}">${escapeHTML(nivel)}</span>`;
    }

    function calcularStatusAutomatico(turma, procId) {
      const def = processosDef.find(p => p.id === procId);
      if (!def) return "neutro";

      const valor = turma[def.campoData];
      const dataProc = parseDataBR(valor);
      if (!dataProc) return "neutro";

      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0);
      const diffDias = Math.round((dataProc - hoje) / (1000 * 60 * 60 * 24));

      if (diffDias < 0)  return "atrasado";
      if (diffDias <= 14) return "embreve";
      return "neutro";
    }

    function getStatusFinal(turma, procId) {
      const tInfo = statusProcessosFirebase[turma.id];
      const reg   = tInfo && tInfo[procId];

      if (reg && (reg.manual || reg.status === "feito")) {
        return reg.status || "neutro";
      }
      return calcularStatusAutomatico(turma, procId);
    }

    // ===== quadro de hor√°rios (corrigido) =====
    function renderQuadroHorarios() {
      const conteudo = document.getElementById("conteudoTurma");
      const diasOrdem = ["Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado"];

      const turmasAtivas = turmas.filter(t => {
        if (t.status === "Em andamento") return true;
        if (mostrarFormacaoNoHorario && t.status === "Em forma√ß√£o") return true;
        return false;
      });

      let html = `
        <h3>üóìÔ∏è Quadro de hor√°rios</h3>

        <div class="schedule-controls">
          <div class="left">
            <label class="chk">
              <input type="checkbox" ${mostrarFormacaoNoHorario ? "checked" : ""} onchange="toggleFormacaoHorario(this.checked)">
              Mostrar turmas <strong>Em forma√ß√£o</strong>
            </label>
          </div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <span class="badge badge-status-andamento">Em andamento</span>
            <span class="badge badge-status-formacao">Em forma√ß√£o</span>
            <span style="font-size:0.78rem; color:var(--muted2);">(clique numa turma para abrir no painel)</span>
          </div>
        </div>
      `;

      const SLOT = 30;

      const getStartMin = (t) => {
        let s = extrairMinutosHorario(t.horario);
        if (s !== null) return s;
        const inter = extrairIntervaloHorario(t.horario);
        return inter.start;
      };

      const getEndMin = (t) => {
        const start = getStartMin(t);
        if (start === null) return null;

        const end = extrairMinutosHorario(t.horarioFim);
        if (end !== null) return end;

        const dur = Number(t.duracaoMin);
        if (Number.isFinite(dur) && dur > 0) return start + dur;

        return start + 120; // turmas antigas
      };

      const starts = turmasAtivas.map(getStartMin).filter(v => v !== null);
      const ends   = turmasAtivas.map(getEndMin).filter(v => v !== null);

      if (starts.length === 0 || ends.length === 0) {
        html += `<div style="color:var(--muted2); font-size:0.9rem;">Nenhuma turma com hor√°rio v√°lido.</div>`;
        conteudo.innerHTML = html;
        return;
      }

      const minStart = Math.floor(Math.min(...starts) / SLOT) * SLOT;

      // ‚úÖ +1 SLOT no fim (o ‚Äúquadrado extra‚Äù que voc√™ pediu)
      const maxEnd = Math.ceil(Math.max(...ends) / SLOT) * SLOT + SLOT;

      const slotsCount = Math.max(1, (maxEnd - minStart) / SLOT);

      // base grid
      html += `<div class="schedule-grid-wrap"><div class="schedule-grid">`;

      html += `<div class="sg-head time" style="grid-column:1;grid-row:1">Hor√°rio</div>`;
      diasOrdem.forEach((d, idx) => {
        html += `<div class="sg-head" style="grid-column:${2 + idx};grid-row:1">${d}</div>`;
      });

      for (let i = 0; i < slotsCount; i++) {
        const tMin = minStart + i * SLOT;
        const row = 2 + i;

        html += `<div class="sg-time" style="grid-column:1;grid-row:${row}">${formatarHora(tMin)}</div>`;
        for (let di = 0; di < 6; di++) {
          html += `<div class="sg-cell" style="grid-column:${2 + di};grid-row:${row}"></div>`;
        }
      }

      html += `</div></div>`;
      conteudo.innerHTML = html;

      const grid = conteudo.querySelector(".schedule-grid");

      // layers
      const layers = [];
      for (let di = 0; di < diasOrdem.length; di++) {
        const layer = document.createElement("div");
        layer.className = "sg-day-layer";
        layer.style.gridColumn = String(2 + di);
        layer.style.gridRow = `2 / span ${slotsCount}`;
        layer.style.pointerEvents = "none";

        layer.style.display = "grid";
        layer.style.gridTemplateRows = `repeat(${slotsCount}, 44px)`;
        layer.style.alignItems = "stretch";

        grid.appendChild(layer);
        layers.push(layer);
      }

      // cards
      turmasAtivas.forEach(t => {
        const di = diasOrdem.indexOf(t.dia);
        if (di < 0) return;

        const start = getStartMin(t);
        let end = getEndMin(t);
        if (start === null) return;
        if (end === null) end = start + 120;

        // ‚úÖ exibi√ß√£o do fim (resolve o crash!)
        const fimParaExibir = t.horarioFim || formatarHora(end);

        // regra: 15:40 -> 15:30
        const startRounded = Math.floor(start / SLOT) * SLOT;

        // dura√ß√£o real
        const durMin = Math.max(1, end - start);

        // ‚úÖ regra pedida: +1 quadrado
        // 120min -> ceil(4)+1 = 5
        // 90min  -> ceil(3)+1 = 4
        let span = Math.max(1, Math.ceil(durMin / SLOT) + 1);

        // posi√ß√£o
        let startIdx = Math.floor((startRounded - minStart) / SLOT);

        // corta se cair antes do range
        const overflowTop = Math.max(0, -startIdx);
        const safeStartIdx = Math.max(0, startIdx);
        let safeSpan = Math.max(1, span - overflowTop);

        // n√£o ultrapassar fim do grid
        safeSpan = Math.min(safeSpan, slotsCount - safeStartIdx);

        const layer = layers[di];
        if (!layer) return;

        const classeStatus = (t.status === "Em andamento") ? "slot-andamento" : "slot-formacao";

        const card = document.createElement("div");
        card.className = `sg-class ${classeStatus}`;
        card.style.gridRow = `${safeStartIdx + 1} / span ${safeSpan}`;
        card.style.margin = "6px";
        card.style.pointerEvents = "auto";
        card.style.alignSelf = "stretch";

        card.innerHTML = `
          <div>${criarBadgeStatus(t.status)} ${criarBadgeNivel(t.nivel)}</div>
          <div class="slot-title">${escapeHTML(t.nome)}</div>
          <div class="slot-sub">
            ${escapeHTML(t.dia)} ‚Ä¢ ${escapeHTML(t.horario)} √†s ${escapeHTML(fimParaExibir)} ‚Ä¢ Alunos: ${escapeHTML(t.alunos ?? "-")}
          </div>
        `;

        card.addEventListener("click", () => abrirTurmaDoHorario(t.id));
        layer.appendChild(card);
      });
    }

    // ====== CRUD: excluir / modal nova turma ======
    window.excluirTurmaSelecionada = function (idTurma, ev) {
      if (ev) ev.stopPropagation();
      const id = idTurma || (turmaSelecionada && turmaSelecionada.id);
      if (!id) { alert("Nenhuma turma selecionada."); return; }

      const turma = turmas.find(t => t.id === id);
      const nomeTurma = turma ? turma.nome : id;

      const confirma = confirm(
        `Deseja realmente EXCLUIR a turma "${nomeTurma}" (ID: ${id})?\n\n` +
        "Essa a√ß√£o n√£o pode ser desfeita."
      );
      if (!confirma) return;

      const turmaRef = ref(db, "turmas/" + id);
      remove(turmaRef)
        .then(() => {
          const procRef = ref(db, "processos/" + id);
          remove(procRef).catch(() => {});
          alert("Turma exclu√≠da com sucesso!");
          if (turmaSelecionada && turmaSelecionada.id === id) turmaSelecionada = null;
          renderListaTurmas();
          window.setModoPainel("overview");
        })
        .catch((err) => {
          console.error("Erro ao excluir turma:", err);
          alert("Erro ao excluir a turma. Veja o console.");
        });
    };

    window.abrirFormularioNovaTurma = function () {
      const modal = document.getElementById("novaTurmaContainer");
      if (!modal) return;

      document.getElementById("novaTurmaId").value = "";
      document.getElementById("novaTurmaDuracao").value = "120";
      document.getElementById("novaTurmaNome").value = "";
      document.getElementById("novaTurmaNivel").value = "Teens";
      document.getElementById("novaTurmaDia").value = "S√°bado";
      document.getElementById("novaTurmaHorario").value = "";
      document.getElementById("novaTurmaStatus").value = "Em forma√ß√£o";
      document.getElementById("novaTurmaAlunos").value = "";
      document.getElementById("novaTurmaDataInicio").value = "";
      document.getElementById("novaTurmaDataFim").value = "";

      modal.style.display = "flex";
    };

    window.fecharFormularioNovaTurma = function () {
      const modal = document.getElementById("novaTurmaContainer");
      if (!modal) return;
      modal.style.display = "none";
    };

    window.salvarNovaTurma = function () {
      const modal = document.getElementById("novaTurmaContainer");
      if (!modal) return;

      const id = document.getElementById("novaTurmaId").value.trim();
      const duracaoMin = parseInt(document.getElementById("novaTurmaDuracao").value, 10);

      if (!Number.isFinite(duracaoMin) || duracaoMin <= 0) {
        alert("Selecione a dura√ß√£o da aula (obrigat√≥ria).");
        return;
      }

      const nome       = document.getElementById("novaTurmaNome").value.trim();
      const nivel      = document.getElementById("novaTurmaNivel").value;
      const dia        = document.getElementById("novaTurmaDia").value;
      const horario    = document.getElementById("novaTurmaHorario").value.trim();
      const status     = document.getElementById("novaTurmaStatus").value;
      const alunosStr  = document.getElementById("novaTurmaAlunos").value;
      const dataInicio = document.getElementById("novaTurmaDataInicio").value.trim();
      const dataFim    = document.getElementById("novaTurmaDataFim").value.trim();

      if (!id || !nome || !horario || !dataInicio) {
        alert("Preencha: ID, nome, hor√°rio e data de in√≠cio.");
        return;
      }
      if (!validarIdTurma(id)) {
        alert("ID inv√°lido. Use apenas n√∫meros (ex: 6761).");
        return;
      }
      if (!validarHorario(horario)) {
        alert("Hor√°rio inv√°lido. Use HH:MM (ex: 18:30).");
        return;
      }

      const iniMin = parseHHMMToMin(horario);
      if (iniMin === null) {
        alert("Hor√°rio inv√°lido. Use HH:MM (ex: 18:30).");
        return;
      }
      const horarioFim = minToHHMM(iniMin + duracaoMin);

      const dIni = parseDateBRorISO(dataInicio);
      if (!dIni) {
        alert("Data de in√≠cio inv√°lida. Use dd/mm/aaaa ou yyyy-mm-dd.");
        return;
      }
      const dataInicioBR = isoToBR(dateToISO(dIni));

      let dataFimBR = "";
      if (dataFim) {
        const dFim = parseDateBRorISO(dataFim);
        if (!dFim) {
          alert("Data de t√©rmino inv√°lida. Use dd/mm/aaaa ou yyyy-mm-dd.");
          return;
        }
        dataFimBR = isoToBR(dateToISO(dFim));
      }

      const jaExiste = turmas.some(t => t.id === id);
      if (jaExiste) {
        alert("J√° existe uma turma com esse ID. Escolha outro ID.");
        return;
      }

      const alunos = alunosStr ? parseInt(alunosStr, 10) : null;

      const dadosNovaTurma = {
        nome,
        nivel,
        dia,
        horario,
        duracaoMin,
        horarioFim,
        status,
        alunos: (alunosStr === "" || isNaN(alunos)) ? null : alunos,

        dataInicio: dataInicioBR,
        dataPausa: "",
        periodoFerias: "",
        dataRetorno: "",
        dataFim: dataFimBR || "",

        totalAulas: null,
        proximoModulo: "",

        grupoWhats: "",
        alinhamentoPais: "",
        audioFeedback: "",
        videosAlunos: "",
        rematricula1: "",
        mensagemTCC: "",
        bombomCartao: "",
        dataTCC: ""
      };

      const total = 21;
      const { datesISO, skipped } = genValidClassDaysISO({
        startDateStr: dataInicioBR,
        diaSemanaPT: dia,
        count: total,
        excludedList: EXCLUSOES_PADRAO
      });

      if (datesISO.length === total) {
        dadosNovaTurma.calendarioAulas = datesISO;
        dadosNovaTurma.totalAulas = total;
        if (!dataFim) dadosNovaTurma.dataFim = isoToBR(datesISO[datesISO.length - 1]);
        Object.assign(dadosNovaTurma, calcularProcessosPorAulas(datesISO));
        dadosNovaTurma.logPulos = skipped.slice(0, 50).join(" | ");
      }

      const turmaRef = ref(db, "turmas/" + id);

      set(turmaRef, dadosNovaTurma)
        .then(() => {
          alert("Turma criada com sucesso!");
          modal.style.display = "none";
          turmaSelecionada = { id, ...dadosNovaTurma };
          renderListaTurmas();
          window.setModoPainel("turma");
          selecionarTurma(id);
        })
        .catch((err) => {
          console.error("Erro ao criar turma:", err);
          alert("Erro ao criar turma. Veja o console para detalhes.");
        });
    };

    // ===== Edi√ß√£o gen√©rica de campos no painel =====
    function normalizarValorCampo(campo, valorStr) {
      const v = (valorStr ?? "").toString().trim();

      if (campo === "alunos" || campo === "totalAulas") {
        if (v === "") return null;
        const n = parseInt(v, 10);
        if (isNaN(n) || n < 0) throw new Error("Digite um n√∫mero v√°lido (0 ou maior), ou deixe vazio para limpar.");
        return n;
      }

      const camposData = new Set(["dataInicio", "dataPausa", "dataRetorno", "dataFim"]);
      if (camposData.has(campo)) {
        if (v === "") return "";
        const d = parseDateBRorISO(v);
        if (!d) throw new Error("Data inv√°lida. Use dd/mm/aaaa ou yyyy-mm-dd.");
        return isoToBR(dateToISO(d));
      }

      return v;
    }

    window.salvarCampoTurma = function(campo, inputId) {
      if (!turmaSelecionada) { alert("Nenhuma turma selecionada."); return; }
      const el = document.getElementById(inputId);
      if (!el) return;

      const turmaId = turmaSelecionada.id;

      let valorFinal;
      try {
        if (campo === "dataInicio" && el.value.trim() === "") {
          alert("A data de in√≠cio √© obrigat√≥ria.");
          return;
        }
        valorFinal = normalizarValorCampo(campo, el.value);
      } catch (err) {
        alert(err.message || "Valor inv√°lido.");
        return;
      }

      const campoRef = ref(db, `turmas/${turmaId}/${campo}`);
      set(campoRef, valorFinal)
        .then(() => {
          turmaSelecionada[campo] = valorFinal;
          const idx = turmas.findIndex(t => t.id === turmaId);
          if (idx >= 0) turmas[idx][campo] = valorFinal;

          window.mostrarSecao("acompanhar");
          renderListaTurmas();
          if (modoPainel === "schedule") renderQuadroHorarios();

          alert("Salvo!");
        })
        .catch((err) => {
          console.error("Erro ao salvar campo:", campo, err);
          alert("Erro ao salvar. Veja o console.");
        });
    };

    function linhaEditavelTexto({ label, campo, valor, placeholder = "-" }) {
      const id = `edit_${campo}`;
      return `
        <div class="linha-info">
          <span class="campo-label">${label}</span>
          <span class="campo-valor" style="display:flex; gap:6px; align-items:center;">
            <input
              id="${id}"
              type="text"
              value="${escapeHTML((valor ?? "").toString())}"
              placeholder="${escapeHTML(placeholder)}"
              style="min-width:220px; padding:2px 6px; font-size:0.85rem; border:1px solid var(--input-border, #d1d5db); border-radius:6px; background:var(--input-bg, #f9fafb); color:var(--text, #111827);"
            />
            <button
              type="button"
              class="btn btn-primario"
              style="padding:4px 10px; font-size:0.8rem;"
              onclick="salvarCampoTurma('${campo}', '${id}')"
            >Salvar</button>
          </span>
        </div>
      `;
    }

    function linhaEditavelNumero({ label, campo, valor, placeholder = "" }) {
      const id = `edit_${campo}`;
      return `
        <div class="linha-info">
          <span class="campo-label">${label}</span>
          <span class="campo-valor" style="display:flex; gap:6px; align-items:center;">
            <input
              id="${id}"
              type="number"
              min="0"
              value="${escapeHTML(valor ?? "")}"
              placeholder="${escapeHTML(placeholder)}"
              style="width:110px; padding:2px 6px; font-size:0.85rem; border:1px solid var(--input-border, #d1d5db); border-radius:6px; background:var(--input-bg, #f9fafb); color:var(--text, #111827);"
            />
            <button
              type="button"
              class="btn btn-primario"
              style="padding:4px 10px; font-size:0.8rem;"
              onclick="salvarCampoTurma('${campo}', '${id}')"
            >Salvar</button>
          </span>
        </div>
      `;
    }

    function linhaEditavelSelect({ label, campo, valor, opcoes }) {
      const id = `edit_${campo}`;
      const opts = opcoes.map(o => {
        const selected = (o === valor) ? "selected" : "";
        return `<option value="${escapeHTML(o)}" ${selected}>${escapeHTML(o)}</option>`;
      }).join("");

      return `
        <div class="linha-info">
          <span class="campo-label">${label}</span>
          <span class="campo-valor" style="display:flex; gap:6px; align-items:center;">
            <select
              id="${id}"
              style="padding:2px 6px; font-size:0.85rem; border:1px solid var(--input-border, #d1d5db); border-radius:6px; background:var(--input-bg, #f9fafb); color:var(--text, #111827);"
            >
              ${opts}
            </select>
            <button
              type="button"
              class="btn btn-primario"
              style="padding:4px 10px; font-size:0.8rem;"
              onclick="salvarCampoTurma('${campo}', '${id}')"
            >Salvar</button>
          </span>
        </div>
      `;
    }

    // ====== Vis√£o geral: edi√ß√£o em duplo clique (‚úÖ FUN√á√ÉO QUE FALTAVA) ======
    function inicializarEdicaoVisaoGeral() {
      const celulas = document.querySelectorAll(".cel-processo");
      celulas.forEach(td => {
        td.addEventListener("dblclick", (ev) => {
          ev.stopPropagation();

          const turmaId = td.dataset.turma;
          const procId  = td.dataset.proc;

          const turmaObj = turmas.find(t => t.id === turmaId);
          if (!turmaObj) return;

          const def = processosDef.find(p => p.id === procId);
          if (!def) return;

          const campo = def.campoData;
          const valorAtual = turmaObj[campo] || "";

          const novoValor = prompt("Digite a nova data (dd/mm/aaaa ou yyyy-mm-dd) ou deixe vazio:", valorAtual);
          if (novoValor === null) return;

          const novoRaw = novoValor.trim();
          let novo = "";

          if (novoRaw !== "") {
            const d = parseDateBRorISO(novoRaw);
            if (!d) { alert("Data inv√°lida."); return; }
            novo = isoToBR(dateToISO(d));
          }

          const campoRef = ref(db, `turmas/${turmaId}/${campo}`);
          set(campoRef, novo)
            .then(() => {
              turmaObj[campo] = novo;
              td.textContent = novo || "-";

              // se tinha override manual e n√£o era feito, remove para voltar autom√°tico
              const reg = statusProcessosFirebase?.[turmaId]?.[procId];
              if (reg?.manual && reg.status !== "feito") {
                const overrideRef = ref(db, `processos/${turmaId}/${procId}`);
                remove(overrideRef).catch(() => {});
              }

              // recalcula classe (status autom√°tico ou manual)
              const status = getStatusFinal(turmaObj, procId);
              cicloStatusProcesso.forEach(s => td.classList.remove("status-" + s));
              td.classList.add("status-" + status);
            })
            .catch(err => {
              console.error("Erro ao editar data na vis√£o geral:", err);
              alert("Erro ao salvar. Veja o console.");
            });
        });
      });
    }

    function criarCardProcesso(idProc, titulo, subtitulo) {
      return `
        <div class="processo-card status-neutro" data-status="neutro"
             data-key="${escapeHTML(turmaSelecionada.id)}::${escapeHTML(idProc)}">
          <div class="processo-titulo">${escapeHTML(titulo)}</div>
          <div class="processo-sub">${escapeHTML(subtitulo || "-")}</div>
          <div class="processo-status-label">Status: Neutro</div>
        </div>`;
    }

    function aplicarEstadoNoCard(card, estado) {
      if (!cicloStatusProcesso.includes(estado)) estado = "neutro";
      card.dataset.status = estado;
      cicloStatusProcesso.forEach(s => card.classList.remove("status-" + s));
      card.classList.add("status-" + estado);

      const label = card.querySelector(".processo-status-label");
      if (label) label.textContent = "Status: " + statusLabelMap[estado];
    }

    function inicializarProcessosClicaveis() {
      const cards = document.querySelectorAll(".processo-card");

      cards.forEach(card => {
        const [turmaId, procId] = card.dataset.key.split("::");
        const turmaObj = turmas.find(t => t.id === turmaId);
        if (!turmaObj) return;

        const estadoInicial = getStatusFinal(turmaObj, procId);
        aplicarEstadoNoCard(card, estadoInicial);

        const caminhoRef = ref(db, `processos/${turmaId}/${procId}`);

        card.addEventListener("click", () => {
          let atual = card.dataset.status || "neutro";
          let i = cicloStatusProcesso.indexOf(atual);
          let proximo = cicloStatusProcesso[(i + 1) % cicloStatusProcesso.length];

          aplicarEstadoNoCard(card, proximo);
          set(caminhoRef, { status: proximo, manual: true });
        });

        const subEl = card.querySelector(".processo-sub");
        if (subEl) {
          subEl.style.textDecoration = "underline";
          subEl.style.cursor = "pointer";
          subEl.title = "Clique para editar a data";

          subEl.addEventListener("click", (ev) => {
            ev.stopPropagation();

            const def = processosDef.find(p => p.id === procId);
            if (!def) return;
            const campo = def.campoData;

            const valorAtual = turmaObj[campo] || "";
            const novoValor = prompt("Digite a data (dd/mm/aaaa ou yyyy-mm-dd) ou deixe vazio:", valorAtual);
            if (novoValor === null) return;

            const novoRaw = novoValor.trim();
            let novo = "";

            if (novoRaw !== "") {
              const d = parseDateBRorISO(novoRaw);
              if (!d) { alert("Data inv√°lida."); return; }
              novo = isoToBR(dateToISO(d));
            }

            const turmaCampoRef = ref(db, `turmas/${turmaId}/${campo}`);
            set(turmaCampoRef, novo)
              .then(() => {
                turmaObj[campo] = novo;
                subEl.textContent = novo || "-";

                const reg = statusProcessosFirebase?.[turmaId]?.[procId];
                if (reg?.manual && reg.status !== "feito") {
                  const overrideRef = ref(db, `processos/${turmaId}/${procId}`);
                  remove(overrideRef).catch(() => {});
                }

                const novoStatus = getStatusFinal(turmaObj, procId);
                aplicarEstadoNoCard(card, novoStatus);
              })
              .catch(err => {
                console.error("Erro ao atualizar data do processo:", err);
                alert("Erro ao salvar a data. Veja o console.");
              });
          });
        }
      });
    }

    function renderVisaoGeral() {
      const conteudo = document.getElementById("conteudoTurma");
      let html = `
        <h3>üìã Vis√£o geral dos processos</h3>
        <p style="font-size:0.8rem;color:#6b7280;margin-bottom:6px;">
          Verde = feito (manual) ‚Ä¢ Laranja = em breve (at√© 14 dias) ‚Ä¢ Vermelho = atrasado ‚Ä¢ Branco = neutro.
        </p>
        <div style="overflow-x:auto;">
          <table class="tabela-visao-geral">
            <thead>
              <tr>
                <th>Turma</th>`;

      processosDef.forEach(p => { html += `<th>${escapeHTML(p.titulo)}</th>`; });
      html += `</tr></thead><tbody>`;

      turmas.forEach(turma => {
        html += `<tr><td class="col-turma">${escapeHTML(turma.nome)}</td>`;
        processosDef.forEach(p => {
          const status = getStatusFinal(turma, p.id);
          const valor  = turma[p.campoData] || "-";
          html += `<td class="cel-processo status-${status}" data-turma="${escapeHTML(turma.id)}" data-proc="${escapeHTML(p.id)}">${escapeHTML(valor)}</td>`;
        });
        html += `</tr>`;
      });

      html += `</tbody></table></div>`;
      conteudo.innerHTML = html;
      inicializarEdicaoVisaoGeral(); // ‚úÖ agora existe
    }

    // ===== filtros =====
    window.alterarFiltros = function() {
      filtroNivel   = document.getElementById("filtroNivel").value;
      filtroDia     = document.getElementById("filtroDia").value;
      filtroHorario = document.getElementById("filtroHorario").value;
      filtroStatus  = document.getElementById("filtroStatus").value;

      turmaSelecionada = null;

      if (modoPainel === "turma") {
        document.getElementById("tituloTurma").textContent = "Selecione uma turma √† esquerda";
        document.getElementById("botoesAcoes").style.display = "none";
        document.getElementById("conteudoTurma").innerHTML = "";
      }

      renderListaTurmas();
    };

    function preencherOpcoesHorario() {
      const selectHorario = document.getElementById("filtroHorario");
      selectHorario.innerHTML = '<option value="todos">Hor√°rio: todos</option>';
      const horariosUnicos = Array.from(new Set(turmas.map(t => t.horario).filter(Boolean))).sort();
      horariosUnicos.forEach(h => {
        const opt = document.createElement("option");
        opt.value = h;
        opt.textContent = h;
        selectHorario.appendChild(opt);
      });
    }

    function renderListaTurmas() {
      const lista  = document.getElementById("listaTurmas");
      const header = lista.querySelector(".lista-header");
      lista.innerHTML = "";
      if (header) lista.appendChild(header);

      const filtradas = turmas.filter(t => {
        if (filtroNivel   !== "todos" && t.nivel   !== filtroNivel)   return false;
        if (filtroDia     !== "todos" && t.dia     !== filtroDia)     return false;
        if (filtroHorario !== "todos" && t.horario !== filtroHorario) return false;
        if (filtroStatus  !== "todas" && t.status  !== filtroStatus)  return false;
        return true;
      });

      filtradas.forEach(turma => {
        const div = document.createElement("div");
        div.className = "turma-card";
        div.dataset.id = turma.id;
        div.innerHTML = `
          <div>${criarBadgeStatus(turma.status)} ${criarBadgeNivel(turma.nivel)}</div>
          <div class="turma-nome">${escapeHTML(turma.nome)}</div>
          <div class="turma-meta">
            Dia: ${escapeHTML(turma.dia)} ‚Ä¢ Hor√°rio: ${escapeHTML(turma.horario)} √†s ${escapeHTML(turma.horarioFim || "-")}<br>
            Alunos: ${escapeHTML(turma.alunos ?? "-")}<br>
            In√≠cio: ${escapeHTML(turma.dataInicio || "-")} ‚Ä¢ T√©rmino: ${escapeHTML(turma.dataFim || "-")}<br>
            <button
              class="btn btn-perigo"
              style="margin-top: 6px; font-size:0.75rem; padding:4px 8px;"
              onclick="excluirTurmaSelecionada('${turma.id}', event)">
              Excluir turma
            </button>
          </div>`;
        div.addEventListener("click", () => selecionarTurma(turma.id));
        lista.appendChild(div);
      });

      if (filtradas.length === 0) {
        const vazio = document.createElement("div");
        vazio.style.fontSize = "0.85rem";
        vazio.style.color = "#6b7280";
        vazio.style.marginTop = "8px";
        vazio.textContent = "Nenhuma turma encontrada com esses filtros.";
        lista.appendChild(vazio);
      }
    }

    function selecionarTurma(id) {
      turmaSelecionada = turmas.find(t => t.id === id);

      document.querySelectorAll(".turma-card").forEach(card => {
        card.classList.toggle("selecionada", card.dataset.id === id);
      });

      if (modoPainel === "turma") {
        const titulo   = document.getElementById("tituloTurma");
        const botoes   = document.getElementById("botoesAcoes");

        titulo.textContent = `Turma selecionada: ${turmaSelecionada.nome}`;
        botoes.style.display = "flex";

        window.mostrarSecao("acompanhar");
      }
    }
    window.selecionarTurma = selecionarTurma;

    function setModoPainel(modo) {
      modoPainel = modo;
      const layoutEl = document.querySelector(".layout");
      if (layoutEl) layoutEl.classList.toggle("modo-schedule", modo === "schedule");

      const tabTurma     = document.getElementById("tabTurma");
      const tabOverview  = document.getElementById("tabOverview");
      const tabSchedule  = document.getElementById("tabSchedule");

      tabTurma.classList.toggle("tab-ativa", modo === "turma");
      tabOverview.classList.toggle("tab-ativa", modo === "overview");
      tabSchedule.classList.toggle("tab-ativa", modo === "schedule");

      const titulo   = document.getElementById("tituloTurma");
      const botoes   = document.getElementById("botoesAcoes");
      const conteudo = document.getElementById("conteudoTurma");

      if (modo === "overview") {
        botoes.style.display = "none";
        titulo.style.display = "none";       // ‚úÖ some com o ‚Äúresto‚Äù do modo turma
        conteudo.innerHTML = "";             // ‚úÖ limpa antes de renderizar
        renderVisaoGeral();
      } 
      else if (modo === "schedule") {
        botoes.style.display = "none";
        titulo.style.display = "none";       // ‚úÖ some com o ‚Äúresto‚Äù do modo turma
        conteudo.innerHTML = "";             // ‚úÖ limpa antes de renderizar
        renderQuadroHorarios();
      } 
      else {
        // modo "turma"
        titulo.style.display = "block";      // ‚úÖ volta
        if (turmaSelecionada) {
          titulo.textContent = `Turma selecionada: ${turmaSelecionada.nome}`;
          botoes.style.display = "flex";
          conteudo.innerHTML = `<p>Escolha uma op√ß√£o acima: <strong>Acompanhar turma</strong> ou <strong>Processos da turma</strong>.</p>`;
        } else {
          titulo.textContent = "Selecione uma turma √† esquerda";
          botoes.style.display = "none";
          conteudo.innerHTML = "";
        }
      }

    }
    window.setModoPainel = setModoPainel;

    window.mostrarSecao = function(tipo) {
      if (!turmaSelecionada) return;
      const conteudo = document.getElementById("conteudoTurma");

      if (tipo === "acompanhar") {
        conteudo.innerHTML = `
          <h3>üìä Acompanhar turma</h3>

          ${linhaEditavelSelect({
            label: "<strong>Status</strong>",
            campo: "status",
            valor: turmaSelecionada.status,
            opcoes: ["Em andamento", "Em forma√ß√£o", "Encerrada"]
          })}

          <div class="linha-info"><span class="campo-label">N√≠vel</span><span class="campo-valor">${escapeHTML(turmaSelecionada.nivel)}</span></div>
          <div class="linha-info"><span class="campo-label">Dia / hor√°rio</span><span class="campo-valor">${escapeHTML(turmaSelecionada.dia)} ‚Ä¢ ${escapeHTML(turmaSelecionada.horario)} √†s ${escapeHTML(turmaSelecionada.horarioFim || "-")}</span></div>

          ${linhaEditavelNumero({ label:"Alunos", campo:"alunos", valor: turmaSelecionada.alunos ?? "" })}

          ${linhaEditavelTexto({ label:"Data de in√≠cio", campo:"dataInicio", valor: turmaSelecionada.dataInicio || "", placeholder:"dd/mm/aaaa" })}
          ${linhaEditavelTexto({ label:"Pausa", campo:"dataPausa", valor: turmaSelecionada.dataPausa || "", placeholder:"dd/mm/aaaa" })}
          ${linhaEditavelTexto({ label:"Per√≠odo de f√©rias", campo:"periodoFerias", valor: turmaSelecionada.periodoFerias || "", placeholder:"ex: Dezembro" })}
          ${linhaEditavelTexto({ label:"Retorno", campo:"dataRetorno", valor: turmaSelecionada.dataRetorno || "", placeholder:"dd/mm/aaaa" })}
          ${linhaEditavelTexto({ label:"T√©rmino", campo:"dataFim", valor: turmaSelecionada.dataFim || "", placeholder:"dd/mm/aaaa" })}

          ${linhaEditavelNumero({ label:"Total de aulas", campo:"totalAulas", valor: turmaSelecionada.totalAulas ?? "" })}

          ${linhaEditavelTexto({ label:"Pr√≥ximo m√≥dulo", campo:"proximoModulo", valor: turmaSelecionada.proximoModulo || "", placeholder:"ex: Teens 2" })}
        `;
      } else if (tipo === "processos") {
        conteudo.innerHTML = `
          <h3>‚öôÔ∏è Processos da turma</h3>
          <p style="font-size:0.8rem; color:#6b7280; margin-bottom:8px;">
            Clique no card para mudar status: neutro ‚Üí em breve ‚Üí atrasado ‚Üí feito.
            Clique na data para editar.
          </p>
          <div class="processos-grid">
            ${criarCardProcesso("grupo_whats", "Grupos de WhatsApp + manual", turmaSelecionada.grupoWhats)}
            ${criarCardProcesso("alinhamento_pais", "Alinhamento com os pais", turmaSelecionada.alinhamentoPais)}
            ${criarCardProcesso("audio_feedback", "√Åudio de feedback + conte√∫dos", turmaSelecionada.audioFeedback)}
            ${criarCardProcesso("videos_alunos", "V√≠deos dos alunos", turmaSelecionada.videosAlunos)}
            ${criarCardProcesso("rematricula1", "1¬™ mensagem de rematr√≠cula", turmaSelecionada.rematricula1)}
            ${criarCardProcesso("mensagem_tcc", "Mensagem sobre o TCC", turmaSelecionada.mensagemTCC)}
            ${criarCardProcesso("bombom_cartao", "Bombom com cart√£o", turmaSelecionada.bombomCartao)}
            ${criarCardProcesso("data_tcc", "Data da apresenta√ß√£o do TCC", turmaSelecionada.dataTCC)}
          </div>
        `;
        inicializarProcessosClicaveis();
      }
    };

    window.toggleFormacaoHorario = function(checked) {
      mostrarFormacaoNoHorario = !!checked;
      if (modoPainel === "schedule") renderQuadroHorarios();
    };

    window.abrirTurmaDoHorario = function(id) {
      window.setModoPainel("turma");
      selecionarTurma(id);
    };

    // ===== Leitura do Firebase =====
    const turmasRef = ref(db, "turmas");
    const processosRootRef = ref(db, "processos");

    onValue(turmasRef, (snap) => {
      const data = snap.val() || {};
      turmas = Object.entries(data).map(([id, dados]) => ({ id, ...dados }));

      if (turmaSelecionada) {
        const encontrada = turmas.find(t => t.id === turmaSelecionada.id);
        turmaSelecionada = encontrada || null;
      }

      preencherOpcoesHorario();
      renderListaTurmas();

      if (modoPainel === "overview") renderVisaoGeral();
      if (modoPainel === "schedule") renderQuadroHorarios();
    });

    onValue(processosRootRef, (snap) => {
      statusProcessosFirebase = snap.val() || {};
      if (modoPainel === "overview") renderVisaoGeral();
    });

    // ===== Inicializa =====
    window.setModoPainel("turma");
  </script>

  <!-- FORMUL√ÅRIO DE CRIA√á√ÉO DE NOVA TURMA -->
  <div id="novaTurmaContainer"
       style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:50; align-items:center; justify-content:center;">
    <div style="background:var(--panel); color:var(--text); border:1px solid var(--border); border-radius:12px; padding:16px; width:100%; max-width:420px; box-shadow:0 10px 30px rgba(0,0,0,0.3);">
      <h3 style="margin-top:0; margin-bottom:8px;">Nova turma</h3>
      <p style="font-size:0.8rem; color:#6b7280; margin-top:0;">
        Preencha os dados b√°sicos da turma. Voc√™ define o ID (por exemplo: 6761, 7117...).
      </p>

      <div style="display:flex; flex-direction:column; gap:6px; font-size:0.85rem;">
        <label>
          ID da turma
          <input id="novaTurmaId" type="text"
                 style="width:100%; padding:4px 6px; border-radius:6px; border:1px solid #d1d5db;">
        </label>

        <label>
          Nome da turma
          <input id="novaTurmaNome" type="text"
                 placeholder="Ex: Teens 1 - Quinta - 18:30 √†s 20:30"
                 style="width:100%; padding:4px 6px; border-radius:6px; border:1px solid #d1d5db;">
        </label>

        <label>
          N√≠vel
          <select id="novaTurmaNivel"
                  style="width:100%; padding:4px 6px; border-radius:6px; border:1px solid #d1d5db;">
            <option value="Kids">Kids</option>
            <option value="Teens">Teens</option>
            <option value="Young">Young</option>
          </select>
        </label>

        <label>
          Dia
          <select id="novaTurmaDia"
                  style="width:100%; padding:4px 6px; border-radius:6px; border:1px solid #d1d5db;">
            <option value="Segunda">Segunda</option>
            <option value="Ter√ßa">Ter√ßa</option>
            <option value="Quarta">Quarta</option>
            <option value="Quinta">Quinta</option>
            <option value="Sexta">Sexta</option>
            <option value="S√°bado">S√°bado</option>
          </select>
        </label>

        <label>
          Hor√°rio (in√≠cio)
          <input id="novaTurmaHorario" type="text"
                 placeholder="Ex: 18:30"
                 style="width:100%; padding:4px 6px; border-radius:6px; border:1px solid #d1d5db;">
        </label>

        <label>
          Dura√ß√£o da aula
          <select id="novaTurmaDuracao"
                  style="width:100%; padding:4px 6px; border-radius:6px; border:1px solid #d1d5db;">
            <option value="90">1h30</option>
            <option value="120">2h</option>
          </select>
        </label>

        <label>
          Status
          <select id="novaTurmaStatus"
                  style="width:100%; padding:4px 6px; border-radius:6px; border:1px solid #d1d5db;">
            <option value="Em andamento">Em andamento</option>
            <option value="Em forma√ß√£o">Em forma√ß√£o</option>
            <option value="Encerrada">Encerrada</option>
          </select>
        </label>

        <label>
          N¬∫ de alunos (opcional)
          <input id="novaTurmaAlunos" type="number" min="0"
                 style="width:100%; padding:4px 6px; border-radius:6px; border:1px solid #d1d5db;">
        </label>

        <label>
          Data de in√≠cio (Obrigat√≥ria)
          <input id="novaTurmaDataInicio" type="text" placeholder="dd/mm/aaaa" required
                 style="width:100%; padding:4px 6px; border-radius:6px; border:1px solid #d1d5db;">
        </label>

        <label>
          Data de t√©rmino (opcional)
          <input id="novaTurmaDataFim" type="text" placeholder="dd/mm/aaaa"
                 style="width:100%; padding:4px 6px; border-radius:6px; border:1px solid #d1d5db;">
        </label>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
        <button class="btn btn-secundario" type="button" onclick="fecharFormularioNovaTurma()">
          Cancelar
        </button>
        <button class="btn btn-primario" type="button" onclick="salvarNovaTurma()">
          Salvar turma
        </button>
      </div>
    </div>
  </div>
</body>
</html>
